<div class="appointments-container">
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <button class="back-button" (click)="goBack()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          Back
        </button>
        <svg width="40" height="40" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="25" cy="25" r="23" stroke="#6366f1" stroke-width="3"/>
          <path d="M18 25 L23 30 L33 20" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1 class="logo-text">IntelliRx - Appointments</h1>
      </div>
      
      <div class="user-section">
        <div class="user-info">
          <div class="user-avatar">{{ currentUser?.name?.charAt(0)?.toUpperCase() }}</div>
          <div class="user-details">
            <span class="user-name">{{ currentUser?.name }}</span>
            <span class="user-email">{{ currentUser?.email }}</span>
          </div>
        </div>
        <button class="logout-button" (click)="logout()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Success/Error Messages -->
    <div *ngIf="successMessage" class="success-message">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      {{ successMessage }}
    </div>

    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <!-- Filters and Actions -->
    <div class="filters-section">
      <div class="filters-left">
        <div class="filter-group">
          <label for="dateFilter">Date</label>
          <input 
            type="date" 
            id="dateFilter" 
            [(ngModel)]="selectedDate" 
            (change)="onDateFilterChange()"
            class="filter-input"
          />
        </div>

        <div class="filter-group">
          <label for="statusFilter">Status</label>
          <select 
            id="statusFilter" 
            [(ngModel)]="selectedStatus" 
            class="filter-input"
          >
            <option value="all">All Appointments</option>
            <option value="scheduled">Scheduled</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
            <option value="no-show">No Show</option>
          </select>
        </div>
      </div>

      <div class="action-buttons-right">
        <button class="primary-btn" (click)="openAddForm()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Schedule Appointment
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading appointments...</p>
    </div>

    <!-- Appointments List -->
    <div *ngIf="!isLoading" class="appointments-section">
      <h2 class="section-title">
        Appointments for {{ formatDateForDisplay(selectedDate) }}
        <span class="count-badge">{{ filteredAppointments.length }}</span>
      </h2>

      <div *ngIf="filteredAppointments.length === 0" class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <h3>No Appointments Found</h3>
        <p>There are no appointments for the selected filters.</p>
      </div>

      <div class="appointments-grid">
        <div *ngFor="let appointment of filteredAppointments" class="appointment-card">
          <div class="appointment-header">
            <div class="appointment-time">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              {{ formatTime(appointment.appointmentTime) }}
            </div>
            <span 
              class="status-badge" 
              [ngClass]="getStatusBadgeClass(appointment.status)"
            >
              {{ appointment.status }}
            </span>
          </div>

          <div class="appointment-body">
            <div class="patient-info">
              <div class="patient-avatar">
                {{ appointment.patientName.charAt(0).toUpperCase() }}
              </div>
              <div class="patient-details">
                <h3 
                  class="patient-name" 
                  (click)="goToPatientDetails(appointment.patientId)"
                >
                  {{ appointment.patientName }}
                </h3>
                <p class="patient-phone">{{ appointment.patientPhone }}</p>
              </div>
            </div>

            <div class="appointment-details">
              <div class="detail-row">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span class="detail-label">Reason:</span>
                <span class="detail-value">{{ appointment.reason }}</span>
              </div>

              <div class="detail-row">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span class="detail-label">Duration:</span>
                <span class="detail-value">{{ appointment.duration }} minutes</span>
              </div>

              <div *ngIf="appointment.notes" class="detail-row notes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="detail-label">Notes:</span>
                <span class="detail-value">{{ appointment.notes }}</span>
              </div>
            </div>
          </div>

          <div class="appointment-actions" *ngIf="appointment.status === 'scheduled'">
            <button 
              class="action-btn complete-btn" 
              (click)="updateAppointmentStatus(appointment.id!, 'completed')"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              Complete
            </button>
            <button 
              class="action-btn no-show-btn" 
              (click)="updateAppointmentStatus(appointment.id!, 'no-show')"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              No Show
            </button>
            <button 
              class="action-btn cancel-btn" 
              (click)="cancelAppointment(appointment.id!)"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Add Appointment Modal -->
<div *ngIf="showAddForm" class="modal-overlay" (click)="closeAddForm()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Schedule Appointment</h2>
      <button class="close-button" (click)="closeAddForm()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Toggle between new/existing patient -->
      <div class="patient-type-toggle">
        <button 
          type="button"
          class="toggle-btn"
          [class.active]="!isNewPatient"
          (click)="!isNewPatient || togglePatientType()"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Existing Patient
        </button>
        <button 
          type="button"
          class="toggle-btn"
          [class.active]="isNewPatient"
          (click)="isNewPatient || togglePatientType()"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <line x1="19" y1="8" x2="19" y2="14"></line>
            <line x1="22" y1="11" x2="16" y2="11"></line>
          </svg>
          New Patient
        </button>
      </div>

      <form (ngSubmit)="onSubmit()">
        <!-- EXISTING PATIENT FORM -->
        <div *ngIf="!isNewPatient" class="form-section">
          <!-- Patient Search -->
          <div class="form-group">
            <label for="patientSearch">Patient *</label>
            <input
              type="text"
              id="patientSearch"
              [(ngModel)]="searchTerm"
              (ngModelChange)="onPatientSearch()"
              name="patientSearch"
              placeholder="Search by name, phone, or family ID"
              class="form-input"
              [class.selected]="selectedPatient"
              [readonly]="selectedPatient !== null"
            />
            
            <div *ngIf="searchResults.length > 0 && !selectedPatient" class="search-results">
              <div 
                *ngFor="let patient of searchResults" 
                class="search-result-item"
                (click)="selectPatient(patient)"
              >
                <div class="result-avatar">{{ patient.name.charAt(0).toUpperCase() }}</div>
                <div class="result-info">
                  <div class="result-name">{{ patient.name }}</div>
                  <div class="result-details">{{ patient.phone }} â€¢ {{ patient.familyId }}</div>
                </div>
              </div>
            </div>

            <button 
              *ngIf="selectedPatient" 
              type="button" 
              class="clear-selection-btn"
              (click)="clearPatientSelection()"
            >
              Change Patient
            </button>
          </div>

          <!-- Date Selection -->
          <div class="form-group">
            <label for="existingPatientDate">Date *</label>
            <input
              type="date"
              id="existingPatientDate"
              [(ngModel)]="appointmentDate"
              (ngModelChange)="onAppointmentDateChange()"
              name="existingPatientDate"
              required
              class="form-input"
            />
          </div>

          <!-- Available Slots Info -->
          <div class="form-group" *ngIf="appointmentDate">
            <label>Available Time Slots</label>
            <div class="slots-info">
              {{ availableSlotsCount }} slots available on {{ formatDateForDisplay(appointmentDate) }}
            </div>
          </div>

          <!-- Time Slot Selection Grid -->
          <div class="form-group" *ngIf="availableTimeSlots.length > 0">
            <label>Select Time Slot *</label>
            <div class="time-slots-grid">
              <button
                *ngFor="let slot of availableTimeSlots"
                type="button"
                class="time-slot"
                [class.available]="slot.available"
                [class.selected]="selectedTimeSlot === slot.time"
                [class.unavailable]="!slot.available"
                [disabled]="!slot.available"
                (click)="selectTimeSlot(slot)"
              >
                <span class="slot-time">{{ formatTimeSlot(slot.time) }}</span>
                <span class="slot-status">
                  <svg *ngIf="slot.available && selectedTimeSlot !== slot.time" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <svg *ngIf="selectedTimeSlot === slot.time" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  {{ slot.available ? (selectedTimeSlot === slot.time ? 'Selected' : 'Available') : 'Booked' }}
                </span>
              </button>
            </div>
          </div>

          <!-- Duration and Reason -->
          <div class="form-row">
            <div class="form-group">
              <label for="existingDuration">Duration *</label>
              <select
                id="existingDuration"
                [(ngModel)]="duration"
                (ngModelChange)="onDurationChange()"
                name="existingDuration"
                class="form-input"
              >
                <option [value]="15">15 minutes</option>
                <option [value]="30">30 minutes</option>
                <option [value]="45">45 minutes</option>
                <option [value]="60">1 hour</option>
              </select>
            </div>

            <div class="form-group">
              <label for="existingReason">Reason *</label>
              <input
                type="text"
                id="existingReason"
                [(ngModel)]="reason"
                name="existingReason"
                placeholder="e.g., Follow-up, Consultation"
                required
                class="form-input"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="existingNotes">Notes (optional)</label>
            <textarea
              id="existingNotes"
              [(ngModel)]="notes"
              name="existingNotes"
              placeholder="Any additional notes"
              class="form-textarea"
              rows="3"
            ></textarea>
          </div>
        </div>

        <!-- NEW PATIENT FORM -->
        <div *ngIf="isNewPatient" class="form-section">
          <!-- Patient Details -->
          <div class="form-row">
            <div class="form-group">
              <label for="newPatientName">Patient Name *</label>
              <input
                type="text"
                id="newPatientName"
                [(ngModel)]="newPatientName"
                name="newPatientName"
                placeholder="Full name"
                required
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label for="newPatientPhone">Phone Number *</label>
              <input
                type="tel"
                id="newPatientPhone"
                [(ngModel)]="newPatientPhone"
                name="newPatientPhone"
                placeholder="10-digit number"
                required
                maxlength="10"
                class="form-input"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="newPatientEmail">Email (Optional)</label>
            <input
              type="email"
              id="newPatientEmail"
              [(ngModel)]="newPatientEmail"
              name="newPatientEmail"
              placeholder="Email address"
              class="form-input"
            />
          </div>

          <!-- Date Selection -->
          <div class="form-group">
            <label for="newPatientDate">Date *</label>
            <input
              type="date"
              id="newPatientDate"
              [(ngModel)]="appointmentDate"
              (ngModelChange)="onAppointmentDateChange()"
              name="newPatientDate"
              required
              class="form-input"
            />
          </div>

          <!-- Available Slots Info -->
          <div class="form-group" *ngIf="appointmentDate">
            <label>Available Time Slots</label>
            <div class="slots-info">
              {{ availableSlotsCount }} slots available on {{ formatDateForDisplay(appointmentDate) }}
            </div>
          </div>

          <!-- Time Slot Selection Grid -->
          <div class="form-group" *ngIf="availableTimeSlots.length > 0">
            <label>Select Time Slot *</label>
            <div class="time-slots-grid">
              <button
                *ngFor="let slot of availableTimeSlots"
                type="button"
                class="time-slot"
                [class.available]="slot.available"
                [class.selected]="selectedTimeSlot === slot.time"
                [class.unavailable]="!slot.available"
                [disabled]="!slot.available"
                (click)="selectTimeSlot(slot)"
              >
                <span class="slot-time">{{ formatTimeSlot(slot.time) }}</span>
                <span class="slot-status">
                  <svg *ngIf="slot.available && selectedTimeSlot !== slot.time" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <svg *ngIf="selectedTimeSlot === slot.time" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  {{ slot.available ? (selectedTimeSlot === slot.time ? 'Selected' : 'Available') : 'Booked' }}
                </span>
              </button>
            </div>
          </div>

          <!-- Duration and Reason -->
          <div class="form-row">
            <div class="form-group">
              <label for="newDuration">Duration *</label>
              <select
                id="newDuration"
                [(ngModel)]="duration"
                (ngModelChange)="onDurationChange()"
                name="newDuration"
                class="form-input"
              >
                <option [value]="15">15 minutes</option>
                <option [value]="30">30 minutes</option>
                <option [value]="45">45 minutes</option>
                <option [value]="60">1 hour</option>
              </select>
            </div>

            <div class="form-group">
              <label for="newReason">Reason for Visit *</label>
              <input
                type="text"
                id="newReason"
                [(ngModel)]="reason"
                name="newReason"
                placeholder="Brief description"
                required
                class="form-input"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="newPatientNotes">Additional Notes (Optional)</label>
            <textarea
              id="newPatientNotes"
              [(ngModel)]="notes"
              name="newPatientNotes"
              placeholder="Any additional information..."
              class="form-textarea"
              rows="3"
            ></textarea>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="cancel-button" (click)="closeAddForm()" [disabled]="isSubmitting">
            Cancel
          </button>
          <button type="submit" class="submit-button" [disabled]="isSubmitting || !isFormValid()">
            <span *ngIf="!isSubmitting">Schedule Appointment</span>
            <span *ngIf="isSubmitting" class="loading-content">
              <span class="loading-spinner"></span>
              Scheduling...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>